___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "displayName": "Qualaroo",
  "description": "Tag template for Qualaroo.",
  "securityGroups": [],
  "__wm": "VGVtcGxhdGUtQXV0aG9yX1F1YWxhcm9vLVNpbW8tQWhhdmE\u003d",
  "categories": [
    "SURVEY"
  ],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "displayName": "gtm-templates-simo-ahava",
    "id": "github.com_gtm-templates-simo-ahava",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "help": "Type the Qualaroo Script URL with leading \"https:\" here. For example: \u003cem\u003ehttps://cl.qualaroo.com/ki.js/13245/aBC.js\u003c/em\u003e.",
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "errorMessage": "The URL must start with \"https://\".",
        "type": "REGEX",
        "args": [
          "^https://.*"
        ]
      }
    ],
    "displayName": "Qualaroo Script URL",
    "simpleValueType": true,
    "name": "scriptUrl",
    "type": "TEXT",
    "valueHint": "https://cl.qualaroo.com/ki.js/13245/aBC.js"
  },
  {
    "simpleValueType": true,
    "name": "gaIntegration",
    "checkboxText": "Add Google Analytics integration",
    "type": "CHECKBOX"
  },
  {
    "enablingConditions": [
      {
        "paramName": "gaIntegration",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "valueValidators": [
      {
        "args": [
          "^UA-\\d+-\\d+$"
        ],
        "errorMessage": "The value must be a valid tracking ID (e.g. UA-12345-1).",
        "type": "REGEX"
      }
    ],
    "displayName": "Google Analytics Tracking ID",
    "simpleValueType": true,
    "name": "gaTrackingId",
    "type": "TEXT"
  },
  {
    "type": "GROUP",
    "name": "additional",
    "displayName": "Additional Features",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "identify",
        "checkboxText": "Identify user",
        "simpleValueType": true,
        "subParams": [
          {
            "type": "TEXT",
            "name": "id",
            "displayName": "User identifier",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "identify",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "disableAuto",
        "checkboxText": "Disable automatic display of surveys",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "selectNudge",
        "checkboxText": "Select a nudge based on current targeting options",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "showSurvey",
        "checkboxText": "Show a specific survey",
        "simpleValueType": true,
        "subParams": [
          {
            "type": "TEXT",
            "name": "surveyId",
            "displayName": "Survey ID",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "showSurvey",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "CHECKBOX",
            "name": "overrideTarget",
            "checkboxText": "Show survey regardless of targeting options or if user has already completed it",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "showSurvey",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "stopSurvey",
        "checkboxText": "Hide any currently displaying survey",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "setAdditionalProperties",
        "checkboxText": "Set additional targeting properties",
        "simpleValueType": true,
        "subParams": [
          {
            "type": "SIMPLE_TABLE",
            "name": "properties",
            "displayName": "",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Property key",
                "name": "key",
                "type": "TEXT",
                "isUnique": true
              },
              {
                "defaultValue": "",
                "displayName": "Property value",
                "name": "value",
                "type": "TEXT"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "setAdditionalProperties",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "newRowButtonText": "Add property"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "setEventHandlers",
        "checkboxText": "Set event handlers",
        "simpleValueType": true,
        "subParams": [
          {
            "type": "SIMPLE_TABLE",
            "name": "eventHandlers",
            "displayName": "",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Event handler",
                "name": "eventHandler",
                "type": "SELECT",
                "selectItems": [
                  {
                    "value": "show",
                    "displayValue": "show"
                  },
                  {
                    "value": "close",
                    "displayValue": "close"
                  },
                  {
                    "value": "nodeRendered",
                    "displayValue": "nodeRendered"
                  },
                  {
                    "value": "submit",
                    "displayValue": "submit"
                  },
                  {
                    "value": "screenerReady",
                    "displayValue": "screenerReady"
                  },
                  {
                    "value": "noTargetMatch",
                    "displayValue": "noTargetMatch"
                  }
                ]
              },
              {
                "defaultValue": "",
                "displayName": "Callback function",
                "name": "callback",
                "type": "TEXT"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "setEventHandlers",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "newRowButtonText": "Add event handler"
          }
        ],
        "help": "See \u003ca href\u003d\"https://help.qualaroo.com/hc/en-us/articles/201447336-Using-Event-Handler-Callbacks\"\u003ethis article\u003c/a\u003e for details on what event handlers you can set and what they do.\n\nNote that the callback for each handler \u003cstrong\u003emust\u003c/strong\u003e be a Google Tag Manager variable that returns a valid function.",
        "defaultValue": "show"
      },
      {
        "type": "CHECKBOX",
        "name": "setCookieExpireDays",
        "checkboxText": "Set cookie expiration (in days)",
        "simpleValueType": true,
        "help": "Check this box to set the expiration of the Qualaroo cookie (in days)",
        "subParams": [
          {
            "type": "TEXT",
            "name": "cookieExpireDays",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "setCookieExpireDays",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_NEGATIVE_NUMBER"
              },
              {
                "type": "NON_EMPTY"
              }
            ],
            "valueHint": "365",
            "valueUnit": "days"
          }
        ],
        "defaultValue": false
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const createQueue = require('createQueue');
const injectScript = require('injectScript');
const createArgumentsQueue = require('createArgumentsQueue');
const makeNumber = require('makeNumber');
const makeTableMap = require('makeTableMap');
const getType = require('getType');

const scriptUrl = data.scriptUrl;

const gaId = data.gaTrackingId;

const kiq = createQueue('_kiq');
if (data.disableAuto) kiq(['disableAuto']);

if (data.gaIntegration) {
  const ga = createArgumentsQueue('ga', 'ga.q');
  ga('create', data.gaTrackingId);
}

const addEvents = () => {
  if (data.identify) kiq(['identify', data.id]);
  if (data.selectNudge) kiq(['selectNudge']);
  if (data.stopSurvey) kiq(['stopSurvey']);
  if (data.showSurvey) kiq(['showSurvey', data.surveyId, data.overrideTarget]);
  if (data.setCookieExpireDays) kiq(['setCookieExpireDays', makeNumber(data.cookieExpireDays)]);
  if (data.setAdditionalProperties && data.properties.length) kiq(['set', makeTableMap(data.properties, 'key', 'value')]);
  if (data.setEventHandlers && data.eventHandlers.length) {
    data.eventHandlers.forEach(e => {
      if (getType(e.callback) === 'function') {
        kiq(['eventHandler', e.eventHandler, e.callback]);
      }
    });
  }
  data.gtmOnSuccess();
};

injectScript(scriptUrl, addEvents, data.gtmOnFailure, 'qualaroo');


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_kiq"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ga"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ga.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cl.qualaroo.com/ki.js/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Check injectScript is called
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('injectScript').wasCalledWith(mockData.scriptUrl, capturedSuccess, capturedFailure, 'qualaroo');
    assertApi('gtmOnSuccess').wasCalled();
- name: Check GA integration is established
  code: |-
    mockData.gaIntegration = true;

    mock('createArgumentsQueue', (f, q) => {
      return function() {
        if (arguments[0] !== 'create' || arguments[1] !== mockData.gaTrackingId) fail('GA queue called with wrong parameter');
      };
    });

    runCode(mockData);

    assertApi('createArgumentsQueue').wasCalledWith('ga', 'ga.q');
    assertApi('gtmOnSuccess').wasCalled();
- name: Check kiq queue is created
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('createQueue').wasCalledWith('_kiq');
    assertApi('gtmOnSuccess').wasCalled();
- name: Check identify command works
  code: |-
    mockData.identify = true;

    mock('createQueue', () => {
      return function(command) {
        if (command[0] !== 'identify' || command[1] !== mockData.id) fail('"identify" failed');
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Check disableAuto works
  code: |-
    mockData.disableAuto = true;

    mock('createQueue', () => {
      return function(command) {
        if (command[0] !== 'disableAuto') fail('"disableAuto" failed');
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Check selectNudge works
  code: |-
    mockData.selectNudge = true;

    mock('createQueue', () => {
      return function(command) {
        if (command[0] !== 'selectNudge') fail('"selectNudge" failed');
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Check showSurvey works
  code: |-
    mockData.showSurvey = true;

    mock('createQueue', () => {
      return function(command) {
        if (command[0] !== 'showSurvey' || command[1] !== mockData.surveyId || command[2] !== mockData.overrideTarget) fail('"showSurvey" failed');
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Check stopSurvey works
  code: |-
    mockData.stopSurvey = true;

    mock('createQueue', () => {
      return function(command) {
        if (command[0] !== 'stopSurvey') fail('"stopSurvey" failed');
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Check set works
  code: |-
    const makeTableMap = require('makeTableMap');

    mockData.setAdditionalProperties = true;

    const props = makeTableMap(mockData.properties, 'key', 'value');

    mock('createQueue', () => {
      return function(command) {
        if (command[0] !== 'set') fail('"set" failed');
        assertThat(command[1], '"set" failed').isEqualTo(props);
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Check eventHandler works
  code: |-
    mockData.setEventHandlers = true;

    mock('createQueue', () => {
      return function(command) {
        if (command[0] !== 'eventHandler') fail('"eventHandler" failed');
        if (command[1] === 'show' && command[2]()) {
          return;
        } else if (command[1] === 'close' && command[2]()) {
          return;
        } else {
          fail('"eventHandler" failed');
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: |-
  const mockData = {
    scriptUrl: 'https://cl.qualaroo.com/ki.js/test',
    gaIntegration: false,
    gaTrackingId: 'UA-12345-1',
    identify: false,
    id: '12345',
    disableAuto: false,
    selectNudge: false,
    showSurvey: false,
    surveyId: '12345',
    overrideTarget: true,
    stopSurvey: false,
    setAdditionalProperties: false,
    properties: [{key: 'prop1', value: 'prop1'},{key: 'prop2', value: 'prop2'}],
    setEventHandlers: false,
    eventHandlers: [{eventHandler: 'show', callback: () => true},{eventHandler: 'close', callback: () => true}]
  };

  let capturedSuccess, capturedFailure;

  mock('injectScript', (url, success, failure, cachebuster) => {
    capturedSuccess = success;
    capturedFailure = failure;
    success();
  });


___NOTES___

Created on 02/08/2019, 11:40:04


